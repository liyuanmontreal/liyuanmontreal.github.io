<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project · Yuan Li</title>

  <!-- Tailwind (dark only via class) -->
  <!-- 1) 先加载插件脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.5.10/dist/typography.min.js"></script>

    <!-- 2) 再声明 tailwind.config，并把插件挂进去 -->
    <script>
    tailwind = {
        config: {
        darkMode: 'class',
        plugins: [typography]   // 这里使用上面加载的全局变量 typography
        }
    }
    </script>

    <!-- 3) 最后再加载 Tailwind 本体 -->
    <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vue & i18n -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/vue-i18n@9/dist/vue-i18n.global.prod.js"></script>

  <!-- Markdown / Mermaid / Vega-Lite / MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    if (window.marked && marked.setOptions) {
      marked.setOptions({ gfm: true, breaks: true });
    }
    function normalizeMdForSoftBreaks(md) {
      let s = (md || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      s = s.replace(/([^\n])\n(?!\n)/g, '$1  \n');
      return s;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false, theme: "dark" });</script>

  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    /* .prose { max-width: 72ch; }
    .prose img { border-radius: 0.75rem; border: 1px solid rgb(51 65 85); }
    .prose a { color: #7dd3fc; }
    .prose p, .prose li { white-space: pre-wrap; } */
    /* —— 改善 Markdown 正文的阅读性 —— */
    .prose { 
      max-width: 72ch;
      line-height: 1.9;               /* 整体行高（桌面端更松） */
    }
    .prose img { border-radius: 0.75rem; border: 1px solid rgb(51 65 85); }
    .prose a { color: #7dd3fc; }

    /* 段落 & 列表：更高的行距 + 保留原来的软换行效果 */
    .prose p, .prose li { 
      white-space: pre-wrap; 
      line-height: 1.9;
    }

    /* 段落与段落 / 列表之间的“段间距” */
    .prose p + p,
    .prose p + ul, .prose p + ol,
    .prose ul + p, .prose ol + p {
      margin-top: 0.95rem;            /* 可按需调到 1.1rem */
    }

    /* 列表项之间稍微拉开一点 */
    .prose li + li { margin-top: 0.4rem; }
    .prose ul, .prose ol { padding-left: 1.25rem; }

    /* 标题的上下间距更舒展 */
    .prose h2 { margin-top: 2.2rem; margin-bottom: 0.9rem; }
    .prose h3 { margin-top: 1.6rem; margin-bottom: 0.6rem; }

    /* 代码块 / 引用 / 表格 / 图片与周围内容的间距 */
    .prose pre,
    .prose blockquote,
    .prose table,
    .prose img {
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    /* 小屏稍微紧凑一点（可选） */
    @media (max-width: 640px) {
      .prose { line-height: 1.8; }
      .prose p, .prose li { line-height: 1.8; }
      .prose p + p,
      .prose p + ul, .prose p + ol,
      .prose ul + p, .prose ol + p { margin-top: 0.8rem; }
    }
    .prose p, .prose li { white-space: pre-wrap; } */
    pre, code { background: transparent !important; }
  </style>
</head>

<body class="bg-slate-900 text-slate-100">
  <div id="app" class="max-w-4xl mx-auto px-6 py-8">
    <div class="flex items-center justify-between">
      <a href="index.html#projects" class="text-sky-300 hover:underline">&larr; {{ t('sections.back') || 'Back' }}</a>
      <div class="flex gap-2">
        <button v-for="l in ['en','zh','fr']"
                :key="l" @click="switchLang(l)"
                class="px-2 py-1 text-xs rounded border border-slate-700 hover:bg-slate-800"
                :class="locale===l ? 'bg-slate-800 text-sky-300' : 'text-slate-300'">
          {{ l.toUpperCase() }}
        </button>
      </div>
    </div>

    <header class="mt-4">
      <h1 class="text-2xl md:text-3xl font-bold text-sky-200" v-if="proj">{{ proj.name }}</h1>
      <div class="mt-2 text-slate-400 text-sm" v-if="proj && proj.tech && proj.tech.length">
        <span v-for="tag in proj.tech" :key="tag"
              class="mr-2 mb-2 inline-flex items-center text-xs px-2 py-1 rounded-full bg-slate-800/70 border border-slate-700">{{ tag }}</span>
      </div>
    </header>

    <!--<img v-if="proj && proj.image" :src="proj.image" class="mt-5 w-full rounded-xl border border-slate-700" :alt="proj?.name">
  -->
    <p class="mt-4 leading-relaxed text-slate-300" v-if="proj">
      {{ proj.description?.[locale] || proj.description?.en }}
    </p>

    <article id="content" class="prose prose-invert mt-6"></article>

    <div class="mt-8 flex gap-3" v-if="proj">
      <a v-if="proj.github" :href="proj.github" target="_blank"
         class="px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 text-white text-sm">GitHub</a>
      <a href="index.html#projects" class="px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 text-sm">
        {{ t('sections.back') || 'Back' }}
      </a>
    </div>
  </div>

<script>
;(async () => {
  const { createApp, ref } = Vue
  const { createI18n } = VueI18n

  const qs = new URL(location.href).searchParams
  const slug = (qs.get('slug') || '').trim()
  const initialLocale = (qs.get('lang') || localStorage.getItem('locale') || 'en').toLowerCase()

  async function loadJSON(p){ return (await fetch(p + '?v=proj-'+Date.now(), { cache:'no-store' })).json() }
  async function loadTextNoCache(url) {
    const u = `${url}?v=${Date.now()}`
    const r = await fetch(u, { cache: 'no-store' })
    if (!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`)
    return r.text()
  }

  async function tryRenderMarkdown(containerId, theSlug, lang) {
    const candidates = [
      `data/projects/${theSlug}.${lang}.md`,
      `data/projects/${theSlug}.en.md`,
      `data/projects/${theSlug}.md`,
      `data/projects/${theSlug.replace(/_/g,'-')}.${lang}.md`,
      `data/projects/${theSlug.replace(/_/g,'-')}.en.md`,
      `data/projects/${theSlug.replace(/_/g,'-')}.md`,
      `data/projects/${theSlug.replace(/-/g,'_')}.${lang}.md`,
      `data/projects/${theSlug.replace(/-/g,'_')}.en.md`,
      `data/projects/${theSlug.replace(/-/g,'_')}.md`
    ]
    let md = '', lastErr = null
    console.group('[project.md] load')
    for (const u of candidates) {
      try { console.log('try:', u); md = await loadTextNoCache(u); console.log('OK:', u); break }
      catch (e) { console.warn('miss:', u, e.message); lastErr = e }
    }
    console.groupEnd()

    const container = document.getElementById(containerId)
    if (!md) {
      container.innerHTML = `
        <div class="p-4 rounded-lg border border-slate-700 bg-slate-800/70">
          <div class="text-sky-300 font-semibold mb-1">No content found</div>
          <div class="text-xs text-slate-400">Check slug & filename; use http:// (not file://)</div>
          <div class="text-xs text-rose-300 mt-2">${lastErr ? lastErr.message : ''}</div>
        </div>`
      return
    }

    const html = marked.parse(normalizeMdForSoftBreaks(md))
    container.innerHTML = html

    try {
      const nodes = container.querySelectorAll('pre > code.language-mermaid')
      let idx = 0
      for (const codeEl of nodes) {
        const code = codeEl.textContent
        const mount = document.createElement('div')
        codeEl.parentElement.replaceWith(mount)
        const id = 'm-' + (idx++)
        const { svg } = await mermaid.render(id, code)
        mount.innerHTML = svg
      }
    } catch (e) { console.warn('Mermaid render error:', e) }

    try {
      const vegaBlocks = container.querySelectorAll('pre > code.language-vega-lite')
      for (const codeEl of vegaBlocks) {
        const mount = document.createElement('div')
        const txt = codeEl.textContent
        codeEl.parentElement.replaceWith(mount)
        await vegaEmbed(mount, JSON.parse(txt), { actions:false, renderer:'svg' })
      }
    } catch (e) { console.warn('Vega-Lite render error:', e) }

    try { window.MathJax?.typesetPromise && await MathJax.typesetPromise() } catch(e) {}
  }

  const messages = {
    en: await loadJSON('i18n/en.json').catch(()=>({sections:{back:'Back'}})),
    zh: await loadJSON('i18n/zh.json').catch(()=>({sections:{back:'返回'}})),
    fr: await loadJSON('i18n/fr.json').catch(()=>({sections:{back:'Retour'}})),
  }
  const i18n = createI18n({ legacy:false, locale: initialLocale, fallbackLocale:'en', messages })

  const App = {
    setup(){
      const { t, locale } = VueI18n.useI18n()
      const proj = ref(null)

      const findProject = async () => {
        const [research, applied] = await Promise.all([
          loadJSON('data/research.json'),
          loadJSON('data/applied.json')
        ])
        const all = [...(research||[]), ...(applied||[])]
        proj.value = all.find(p => (p.slug && p.slug === slug) ||
                                   (!p.slug && encodeURIComponent(p.name) === slug)) || null
      }

      const renderNow = async () => {
        const lang = (locale.value || 'en').toLowerCase()
        await tryRenderMarkdown('content', slug, lang)
      }

      ;(async () => { await findProject(); await renderNow() })()

      const switchLang = async (l) => {
        locale.value = l
        localStorage.setItem('locale', l)
        await renderNow()
      }

      window.addEventListener('storage', (e) => {
        if (e.key === 'locale') renderNow()
      })

      return { t, proj, locale, switchLang }
    }
  }

  Vue.createApp(App).use(i18n).mount('#app')
})()
</script>
</body>
</html>
